name: Redaction CI/CD

# This is the main CI/CD pipeline of the the redaction system
parameters:
# User-specified environment to deploy to
- name: env
  default: 'dev'
  values:
  - 'dev'
  - 'test'
  - 'prod'

# Run when Pull Request raised to the main branch
pr:
- main

# Run when merged into main
trigger:
 branches:
  include:
    - main

resources:
  repositories:
    - repository: templates
      type: github
      endpoint: Planning-Inspectorate
      name: Planning-Inspectorate/common-pipeline-templates
      ref: refs/tags/release/3.24.2

extends:
  template: stages/wrapper_ci.yml@templates
  parameters:
    validateName: Redaction CI
    globalVariables:
      - template: pipelines/azure-pipelines-variables.yml@self
    validationJobs:
      - name: ValidateCode
        steps:
          - checkout: self
            clean: true
          - script: |
              set -e
              cd redaction-system
              python3 -m pip install ruff
              export PYTHONPATH=$(pwd)
              python3 -m ruff check redactor
              python3 -m ruff format --check redactor
            displayName: 'Python code style check'
      - name: RunTestsJob
        steps:
          - checkout: self
            clean: true
          - checkout: templates
          - template: ../steps/azure_auth.yml@templates
            parameters:
              subscriptionId: $(SUBSCRIPTION_ID_${{ upper(parameters.env) }})
          - script: |
              set -e
              cd redaction-system
              python3 -m pip install -r redactor/requirements.txt
            displayName: 'Install requirements'
          - script: |
              set -e
              cd redaction-system/redactor
              export PYTHONPATH=$(pwd)
              python3 -m pytest test/unit_test -vv -rP -n 4 --junitxml=junit/unit_test_results.xml --cov="core" --cov-report=xml:unit_test_coverage.xml
              python3 -m coverage report --fail-under=$(unitTestCoverageThreshold) --show-missing
              mv .coverage .coverage.unit
            displayName: 'Run unit tests'
          - task: PublishTestResults@2
            displayName: 'Publish unit test results'
            condition: succeededOrFailed()
            inputs:
              testResultsFiles: '**/unit_test_results.xml'
              testRunTitle: 'Redaction System unit test report - $(Build.BuildId) - $(Build.SourceBranch)'
              mergeTestResults: true
          # - script: |
          #     set -e
          #     cd redaction-system/redactor
          #     export PYTHONPATH=$(pwd)
          #     python3 -m pytest test/integration_test -vv -rP -n 4 --junitxml=junit/integration_test_results.xml --cov="core" --cov-report=xml:integration_test_coverage.xml
          #     python3 -m coverage report --fail-under=$(integrationTestCoverageThreshold) --show-missing
          #     mv .coverage .coverage.integration
          #   displayName: 'Run integration tests'
          # - task: PublishTestResults@2
          #   displayName: 'Publish integration test results'
          #   condition: succeededOrFailed()
          #   inputs:
          #     testResultsFiles: '**/integration_test_results.xml'
          #     testRunTitle: 'Redaction System integration test report - $(Build.BuildId) - $(Build.SourceBranch)'
          #     mergeTestResults: true


          # ---------- E2E: start Azurite + Functions host + run tests ----------

          - task: NodeTool@0
            displayName: 'Install Node.js (for Azure Functions Core Tools + Azurite)'
            inputs:
              versionSpec: '20.x'

          - script: |
              set -e
              node --version
              npm --version
              npm i -g azure-functions-core-tools@4 --unsafe-perm true
              npm i -g azurite --unsafe-perm true
              func --version
              azurite --version
            displayName: 'Install Azure Functions Core Tools + Azurite'

          - script: |
              set -e
              cd redaction-system

              echo "Starting Azurite..."
              mkdir -p azurite-data
              nohup azurite --silent --location azurite-data --debug /agent/_work/1/s/redaction-system/azurite.log > /agent/_work/1/s/redaction-system/azurite.stdout.log 2>&1 &
              echo $! > /agent/_work/1/s/redaction-system/azurite.pid

              # quick wait for blob port
              for i in $(seq 1 30); do
                if curl -fsS http://127.0.0.1:10000 >/dev/null 2>&1; then
                  echo "Azurite is up"
                  exit 0
                fi
                sleep 1
              done

              echo "Azurite did not start. Last 200 lines:"
              tail -n 200 /agent/_work/1/s/redaction-system/azurite.stdout.log || true
              tail -n 200 /agent/_work/1/s/redaction-system/azurite.log || true
              exit 1
            displayName: 'Start Azurite (background) + wait'

          - script: |
              set -e
              cd redaction-system/redactor

              echo "Exporting Function App environment variables..."

              # Core Functions runtime
              export FUNCTIONS_WORKER_RUNTIME=python
              export AzureWebJobsStorage=UseDevelopmentStorage=true
              export AzureWebJobsSecretStorageType=files

              # Disable Managed Identity (critical in CI)
              export AZURE_IDENTITY_DISABLE_MANAGED_IDENTITY=true

              # App configuration (from pipeline variables / variable group)
              export OPENAI_ENDPOINT="$(OPENAI_ENDPOINT)"
              export OPENAI_KEY="$(OPENAI_KEY)"
              export AZURE_VISION_ENDPOINT="$(AZURE_VISION_ENDPOINT)"
              export AZURE_VISION_KEY="$(AZURE_VISION_KEY)"

              # App Insights (use the correct canonical name)
              export APPLICATIONINSIGHTS_CONNECTION_STRING="$(APP_INSIGHTS_CONNECTION_STRING)"
              export APP_INSIGHTS_CONNECTION_STRING="$(APP_INSIGHTS_CONNECTION_STRING)"

              echo "Starting Azure Functions host..."
              nohup func start --port 7071 > ../func-host.log 2>&1 &
              echo $! > ../func-host.pid

              echo "Waiting for Functions host to become ready..."
              for i in {1..60}; do
                if curl -sSf http://localhost:7071/api/redact >/dev/null 2>&1; then
                  echo "Functions host is up"
                  exit 0
                fi
                sleep 2
              done

              echo "Functions host did not start in time"
              tail -n 200 ../func-host.log
              exit 1
            displayName: 'Start local Azure Functions host'


          - script: |
              set -e
              cd redaction-system/redactor
              export PYTHONPATH=$(pwd)

              export E2E_FUNCTION_BASE_URL="http://localhost:7071"
              export E2E_STORAGE_ACCOUNT="pinsstredactiontestuks"
              export E2E_CONTAINER_NAME="pinsfuncredactionsystemtestuks-applease"
              export E2E_RUN_ID="ado-$(Build.BuildId)"
              export E2E_SKIP_REDACTION="false"

              # keep tests from trying IMDS
              export AZURE_IDENTITY_DISABLE_MANAGED_IDENTITY=true

              python3 -m pytest -m e2e -vv -rP --junitxml=junit/e2e_test_results.xml
            displayName: 'Run e2e tests'

          - script: |
              set +e
              echo "Stopping Functions host..."
              if [ -f redaction-system/func-host.pid ]; then
                kill $(cat redaction-system/func-host.pid) || true
              fi
              pkill -f "func start" || true
              pkill -f "azure-functions-core-tools" || true
              pkill -f "workers/python" || true

              echo "Stopping Azurite..."
              if [ -f redaction-system/azurite.pid ]; then
                kill $(cat redaction-system/azurite.pid) || true
              fi
              pkill -f "azurite" || true
              echo "Done"
            displayName: 'Stop local hosts'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish local host logs'
            condition: always()
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/redaction-system'
              ArtifactName: 'local-host-logs'



            
          - script: |
              set -e
              cd redaction-system/redactor
              python3 -m coverage combine
              python3 -m coverage report
              python3 -m coverage xml -o coverage.xml
            displayName: 'Combine coverage reports'
          - task: UseDotNet@2
            displayName: 'Install latest .net'
            inputs:
              packageType: 'sdk'
              version: '8.x'
          - task: PublishCodeCoverageResults@2
            displayName: 'Publish coverage reports'
            inputs:
              summaryFileLocation: '$(Build.SourcesDirectory)/redaction-system/coverage.xml'
          - script: |
              set -e
              cd redaction-system/redactor
              python3 -m coverage report --fail-under=$(totalTestCoverageThreshold) --show-missing
            displayName: 'Fail if test coverage is below the threshold'
