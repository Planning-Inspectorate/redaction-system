name: Redaction CD

# This is the main CI/CD pipeline of the the redaction system
parameters:
# User-specified environment to deploy to
- name: env
  default: 'dev'
  values:
  - 'dev'
  - 'test'
  - 'prod'

resources:
  repositories:
    - repository: templates
      type: github
      endpoint: Planning-Inspectorate
      name: Planning-Inspectorate/common-pipeline-templates
      ref: refs/tags/release/3.24.2

extends:
  template: stages/wrapper_cd.yml@templates
  parameters:
    globalVariables:
      - template: pipelines/azure-pipelines-variables.yml@self
    deploymentStages:
      - name: Deploy Function App
        deploymentJobs:
          - name: Deploy Function App
            steps:
              - checkout: self
                displayName: 'Checkout repo'
              
              # Create a zip file of all the files in the filelist.
              - script: |
                  set -e
                  curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
                  sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
                  sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-$(lsb_release -cs 2>/dev/null)-prod $(lsb_release -cs 2>/dev/null) main" > /etc/apt/sources.list.d/dotnetdev.list'
                  sudo apt-get update
                  sudo apt-get install azure-functions-core-tools-4
                  cd $(Build.SourcesDirectory)/redactor
                  func azure functionapp publish 'pins-func-redaction-system-${{ parameters.env }}-uks' --python
                displayName: 'Deploy function app'
