name: Redaction CD

# This is the main CI/CD pipeline of the the redaction system
parameters:
# User-specified environment to deploy to
- name: env
  default: 'Dev'
  values:
  - 'Dev'
  - 'Test'
  - 'Prod'

resources:
  repositories:
    - repository: templates
      type: github
      endpoint: Planning-Inspectorate
      name: Planning-Inspectorate/common-pipeline-templates
      ref: refs/tags/release/3.24.2

extends:
  template: stages/wrapper_cd.yml@templates
  parameters:
    globalVariables:
      - template: pipelines/azure-pipelines-variables.yml@self
    environments:
      - name: ${{ parameters.env }}
    deploymentStages:
      - name: Deploy Function App
        deploymentJobs:
          - name: Deploy Function App
            steps:
              - checkout: self
                displayName: 'Checkout repo'
              
              # Create a zip file of all the files in the filelist.
              - script: |
                  set -e
                  cd $(Build.SourcesDirectory)/redactor
                  zip -r $(Build.ArtifactStagingDirectory)/redactor.zip .
                displayName: 'Archive top level files'
              
              # Publish the zip file as an artifact to be used further in the pipeline.
              - task: PublishBuildArtifacts@1
                displayName: 'Publish build artifact'
                inputs:
                  PathtoPublish: '$(Build.ArtifactStagingDirectory)'
                  ArtifactName: 'FunctionCode'
              
              # Download the artifact first - the zip file.
              - task: DownloadBuildArtifacts@1
                displayName: 'Download function code artifact'
                inputs:
                  buildType: 'current'
                  artifactName: 'FunctionCode'
                  downloadPath: '$(System.ArtifactsDirectory)'

              # Use the Azure CLI to deploy the zip file to the Function App in Azure.
              #- task: AzureCLI@2
              #  displayName: 'Deploy to function app'
              #  inputs:
              #    azureSubscription: 'Azure DevOps Pipelines - Redaction System - Infrastructure ${{ upper(parameters.env) }}'
              #    scriptType: 'bash'
              #    scriptLocation: 'inlineScript'
              #    inlineScript: |
              #      az functionapp deployment source config-zip \
              #      --resource-group 'pins-rg-redaction-${{ lower(parameters.env) }}-uks' \
              #      --name 'pins-func-redaction-system-${{ lower(parameters.env) }}-uks' \
              #      --src '$(System.ArtifactsDirectory)/FunctionCode/redactor.zip' \
              #      --build-remote true \
              #      --verbose
              # Run a quick smoke test to check connectivity
              - task: AzureCLI@2
                displayName: 'Run function app smoke test'
                inputs:
                  azureSubscription: 'Azure DevOps Pipelines - Redaction System - Infrastructure ${{ upper(parameters.env) }}'
                  scriptType: 'bash'
                  scriptLocation: 'inlineScript'
                  inlineScript: |
                    python3 -m pip inatall pytest
                    python3 -m pytest redactor/test/smoke_test/test_connectivity.py
