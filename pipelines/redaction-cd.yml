name: Redaction CD

# This is the main CI/CD pipeline of the the redaction system
parameters:
# User-specified environment to deploy to
- name: env
  default: 'dev'
  values:
  - 'dev'
  - 'test'
  - 'prod'

resources:
  repositories:
    - repository: templates
      type: github
      endpoint: Planning-Inspectorate
      name: Planning-Inspectorate/common-pipeline-templates
      ref: refs/tags/release/3.24.2

extends:
  template: stages/wrapper_cd.yml@templates
  parameters:
    globalVariables:
      - template: pipelines/azure-pipelines-variables.yml@self
    deploymentStages:
      - name: Deploy Function App
        deploymentJobs:
          - name: Deploy Function App
            steps:
              - checkout: self
                displayName: 'Checkout repo'
              
              # Create a zip file of all the files in the filelist.
              - script: |
                  cd $(Build.SourcesDirectory)/redactor
                  xargs zip -r $(Build.ArtifactStagingDirectory)/functions.zip
                displayName: 'Archive top level files'
              
              # Publish the zip file as an artifact to be used further in the pipeline.
              - task: PublishBuildArtifacts@1
                displayName: 'Publish build artifact'
                inputs:
                  PathtoPublish: '$(Build.ArtifactStagingDirectory)'
                  ArtifactName: 'FunctionCode'
              
              # Download the artifact first - the zip file.
              - task: DownloadBuildArtifacts@1
                displayName: 'Download function code artifact'
                inputs:
                  buildType: 'current'
                  artifactName: 'FunctionCode'
                  downloadPath: '$(System.ArtifactsDirectory)'

              # Use the Azure CLI to deploy the zip file to the Function App in Azure.
              - template: ${{variables['System.DefaultWorkingDirectory']}}/pipelines/steps/deploy_to_function_app.yaml
                parameters:
                  environment: ${{ parameters.env }}
                  resourceGroup: 'pins-rg-redaction-${{ parameters.env }}-uks'
                  functionApp: 'pins-func-redaction-system-${{ parameters.env }}-uks'
                  zipFile: '$(System.ArtifactsDirectory)/FunctionCode/functions.zip'
